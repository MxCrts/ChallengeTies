import * as Location from "expo-location";
import { doc, updateDoc, getDoc, serverTimestamp } from "firebase/firestore";
import { db, auth } from "../constants/firebase-config";

// R√©cup√®re la localisation r√©elle, reverse-geocode, et met √† jour Firestore
export const fetchAndSaveUserLocation = async (): Promise<boolean> => {
  try {
    // 1. Permission
    const { status } = await Location.requestForegroundPermissionsAsync();
    console.log("üîç Permission localisation:", status);
    if (status !== "granted") {
      console.warn("‚ö†Ô∏è Permission de localisation refus√©e.");
      return false;
    }

    // 2. R√©cup√®re la position GPS r√©elle
    const location = await Location.getCurrentPositionAsync({
      accuracy: Location.Accuracy.Highest,
    });
    console.log(
      "üìç Coordonn√©es GPS r√©elles:",
      location.coords.latitude,
      location.coords.longitude
    );

    // 3. Reverse geocode
    let geocode: Location.LocationGeocodedAddress[] = [];
    try {
      geocode = await Location.reverseGeocodeAsync({
        latitude: location.coords.latitude,
        longitude: location.coords.longitude,
      });
      console.log("üåç R√©ponse reverseGeocode:", geocode);
    } catch (e) {
      console.warn("‚ö†Ô∏è √âchec reverseGeocode, on utilise fallback Madrid.", e);
    }

    // 4. D√©termine country/region
    let country: string = "Spain";
    let region: string = "Community of Madrid";

    if (geocode.length > 0) {
      const addr = geocode[0];
      country = addr.country ?? country;
      region = addr.region ?? addr.subregion ?? region;

      // normalisation
      if (country === "Espa√±a" || country === "ES") country = "Spain";
      if (region === "Madrid" || region === "Comunidad de Madrid")
        region = "Community of Madrid";
    }

    console.log("‚úÖ Pays:", country, "üèûÔ∏è R√©gion:", region);

    // 5. Met √† jour Firestore
    const userId = auth.currentUser?.uid;
    if (!userId) {
      console.warn("‚ö†Ô∏è Aucun utilisateur connect√©.");
      return false;
    }

    const userRef = doc(db, "users", userId);
    const userSnap = await getDoc(userRef);
    if (!userSnap.exists()) {
      console.warn("‚ö†Ô∏è Doc utilisateur introuvable:", userId);
      return false;
    }

    await updateDoc(userRef, {
      country,
      region,
      locationEnabled: status === "granted",
      updatedAt: serverTimestamp(),
    });

    console.log(
      `‚úÖ Localisation enregistr√©e pour ${userId} : ${region}, ${country}`
    );
    return true;
  } catch (error) {
    console.error("‚ùå Erreur fetchAndSaveUserLocation:", error);
    return false;
  }
};
